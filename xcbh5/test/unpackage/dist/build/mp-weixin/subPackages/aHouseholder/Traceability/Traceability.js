(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["subPackages/aHouseholder/Traceability/Traceability"],{"2b25":function(e,t,i){"use strict";i.r(t);var n=i("8680"),s=i("33ef");for(var o in s)["default"].indexOf(o)<0&&function(e){i.d(t,e,(function(){return s[e]}))}(o);i("7e5c");var c=i("828b"),a=Object(c["a"])(s["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],void 0);t["default"]=a.exports},"33ef":function(e,t,i){"use strict";i.r(t);var n=i("39e4"),s=i.n(n);for(var o in n)["default"].indexOf(o)<0&&function(e){i.d(t,e,(function(){return n[e]}))}(o);t["default"]=s.a},"39e4":function(e,t,i){"use strict";(function(e){var n=i("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=n(i("7ca3")),o=i("4860");function c(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?c(Object(i),!0).forEach((function(t){(0,s.default)(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):c(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var r={data:function(){return{TraceabilityInfo:{Students:"",productionDate:"",batchNumber:"",pesticideName:"",pesticideTimes:"",lastPesticideDate:"",irrigationWater:"",plantingCycle:"",soilType:"",feedName:"",feedSource:"",breedingCycle:"",epidemicPrevention:"",breedingEnvironment:"",breedingMethod:"",processingMaterials:"",foodAdditives:"",processingTechnology:"",processingEnvironment:"",processingEquipment:"",productMaterial:"",manufacturer:"",manufacturerAddress:"",manufacturerPhone:"",productCertification:"",transportMethod:"",storageConditions:"",shelfLife:"",nutritionValue:"",cookingMethod:"",notes:""},CLASSIFICATION:["种植","养殖","加工","其他"],classificationIndex:0,index:0,commodityLis:[],commodityTempLis:[],currentInputValue:"",currentInputField:"",isSubmitting:!1,certificateImages:[],feedCertImages:[],pesticideCertImages:[],processingCertImages:[],otherCertImages:[]}},computed:{formCompletionRate:function(){var e=this,t=["Students","productionDate",{key:"feedName",show:1===this.classificationIndex},{key:"pesticideName",show:0===this.classificationIndex},{key:"processingMaterials",show:2===this.classificationIndex},{key:"productMaterial",show:3===this.classificationIndex},{key:"feedCertImages",show:1===this.classificationIndex,check:function(){return e.feedCertImages.length>0}},{key:"pesticideCertImages",show:0===this.classificationIndex,check:function(){return e.pesticideCertImages.length>0}},{key:"processingCertImages",show:2===this.classificationIndex,check:function(){return e.processingCertImages.length>0}},{key:"otherCertImages",show:3===this.classificationIndex,check:function(){return e.otherCertImages.length>0}}],i=0,n=0;return t.forEach((function(t){(void 0===t.show||t.show)&&(n++,t.check?i+=t.check()?1:0:i+=e.TraceabilityInfo[t.key]?1:0)})),Math.round(i/n*100)}},onLoad:function(){this.loadCommodityList()},methods:{loadCommodityList:function(){var e=this;o.api.myShoplist({isshow:1}).then((function(t){e.commodityLis=t.data.listdata||[],e.commodityTempLis=e.commodityLis.map((function(e){return e.commodity_name}))})).catch((function(e){console.error("加载商品列表失败",e)}))},changeClassification:function(e){this.classificationIndex=e.detail.value},openLocationPicker:function(){var t=this;e.chooseLocation({success:function(i){t.TraceabilityInfo.Students=i.name+i.address,e.showToast({title:"已选择地址",icon:"success",duration:1500})}})},chooseFeedCertificate:function(){var t=this;e.chooseImage({count:3-this.feedCertImages.length,success:function(e){t.feedCertImages=t.feedCertImages.concat(e.tempFilePaths)}})},choosePesticideCertificate:function(){var t=this;e.chooseImage({count:3-this.pesticideCertImages.length,success:function(e){t.pesticideCertImages=t.pesticideCertImages.concat(e.tempFilePaths)}})},chooseProcessingCertificate:function(){var t=this;e.chooseImage({count:3-this.processingCertImages.length,success:function(e){t.processingCertImages=t.processingCertImages.concat(e.tempFilePaths)}})},chooseOtherCertificate:function(){var t=this;e.chooseImage({count:3-this.otherCertImages.length,success:function(e){t.otherCertImages=t.otherCertImages.concat(e.tempFilePaths)}})},chooseCertificateImage:function(){var t=this;e.chooseImage({count:3-this.certificateImages.length,success:function(e){t.certificateImages=t.certificateImages.concat(e.tempFilePaths)}})},deleteCertificate:function(e,t){"feed"===t?this.feedCertImages.splice(e,1):"pesticide"===t?this.pesticideCertImages.splice(e,1):"processing"===t?this.processingCertImages.splice(e,1):"other"===t?this.otherCertImages.splice(e,1):this.certificateImages.splice(e,1)},submit:function(){var t=this;if(this.TraceabilityInfo.Students)if(this.TraceabilityInfo.productionDate){if(1===this.classificationIndex){if(!this.TraceabilityInfo.feedName)return void e.showToast({title:"请填写饲料名称",icon:"none"});if(!this.TraceabilityInfo.feedSource)return void e.showToast({title:"请填写饲料来源",icon:"none"});if(0===this.feedCertImages.length)return void e.showToast({title:"请上传饲料检测报告",icon:"none"})}if(0===this.classificationIndex){if(!this.TraceabilityInfo.pesticideName)return void e.showToast({title:"请填写农药名称",icon:"none"});if(0===this.pesticideCertImages.length)return void e.showToast({title:"请上传农残检测报告",icon:"none"})}if(2===this.classificationIndex){if(!this.TraceabilityInfo.processingMaterials)return void e.showToast({title:"请填写加工原料",icon:"none"});if(0===this.processingCertImages.length)return void e.showToast({title:"请上传加工卫生许可证",icon:"none"})}if(3===this.classificationIndex){if(!this.TraceabilityInfo.productMaterial)return void e.showToast({title:"请填写产品材质",icon:"none"});if(!this.TraceabilityInfo.manufacturer)return void e.showToast({title:"请填写生产厂家",icon:"none"});if(!this.TraceabilityInfo.manufacturerAddress)return void e.showToast({title:"请填写生产地址",icon:"none"});if(0===this.otherCertImages.length)return void e.showToast({title:"请上传安全检测报告",icon:"none"})}this.isSubmitting=!0;var i=a(a({},this.TraceabilityInfo),{},{commodity_id:this.commodityLis[this.index].commodity_id,classification:this.classificationIndex,formCompletionRate:this.formCompletionRate}),n=[];this.certificateImages.length>0&&n.push(this.uploadImages(this.certificateImages,"certificate")),0===this.classificationIndex&&this.pesticideCertImages.length>0&&n.push(this.uploadImages(this.pesticideCertImages,"pesticide")),1===this.classificationIndex&&this.feedCertImages.length>0&&n.push(this.uploadImages(this.feedCertImages,"feed")),2===this.classificationIndex&&this.processingCertImages.length>0&&n.push(this.uploadImages(this.processingCertImages,"processing")),3===this.classificationIndex&&this.otherCertImages.length>0&&n.push(this.uploadImages(this.otherCertImages,"other")),Promise.all(n).then((function(n){n.forEach((function(e){"certificate"===e.type?i.certificateUrls=e.urls:"pesticide"===e.type?i.pesticideCertUrls=e.urls:"feed"===e.type?i.feedCertUrls=e.urls:"processing"===e.type?i.processingCertUrls=e.urls:"other"===e.type&&(i.otherCertUrls=e.urls)})),o.api.submitTraceabilityInfo(i).then((function(t){e.showToast({title:"提交成功",icon:"success",duration:2e3}),setTimeout((function(){e.navigateBack()}),2e3)})).catch((function(t){e.showToast({title:"提交失败",icon:"none",duration:2e3}),console.error("提交失败",t)})).finally((function(){t.isSubmitting=!1}))})).catch((function(i){e.showToast({title:"图片上传失败",icon:"none",duration:2e3}),console.error("图片上传失败",i),t.isSubmitting=!1}))}else e.showToast({title:"请选择生产日期",icon:"none"});else e.showToast({title:"请填写产地",icon:"none"})},uploadImages:function(t,i){return new Promise((function(n,s){var o=[],c=0;t.forEach((function(a,r){e.uploadFile({url:"https://your-api-domain.com/upload",filePath:a,name:"file",formData:{type:i},success:function(e){var t=JSON.parse(e.data);0===t.code?o.push(t.data.url):s(new Error("图片上传失败: ".concat(t.msg)))},fail:function(e){s(e)},complete:function(){c++,c===t.length&&n({type:i,urls:o})}})}))}))},openPopup:function(e){this.currentInputField=e,this.currentInputValue=this.TraceabilityInfo[e]||"",this.$refs.popup.open()},handleInputConfirm:function(){this.currentInputField&&(this.TraceabilityInfo[this.currentInputField]=this.currentInputValue),this.$refs.popup.close()}}};t.default=r}).call(this,i("3223")["default"])},"69af":function(e,t,i){"use strict";(function(e,t){var n=i("47a9");i("89ee");n(i("3240"));var s=n(i("2b25"));e.__webpack_require_UNI_MP_PLUGIN__=i,t(s.default)}).call(this,i("3223")["default"],i("df3c")["createPage"])},"7e5c":function(e,t,i){"use strict";var n=i("d015"),s=i.n(n);s.a},8680:function(e,t,i){"use strict";i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return o})),i.d(t,"a",(function(){return n}));var n={uniDatetimePicker:function(){return Promise.all([i.e("common/vendor"),i.e("uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker")]).then(i.bind(null,"173b"))},uniPopup:function(){return i.e("uni_modules/uni-popup/components/uni-popup/uni-popup").then(i.bind(null,"8858"))}},s=function(){var e=this.$createElement;this._self._c},o=[]},d015:function(e,t,i){}},[["69af","common/runtime","common/vendor"]]]);