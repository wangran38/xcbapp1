{"version":3,"file":"useUpload.js","sources":["hooks/useUpload.js"],"sourcesContent":["import request, {\r\n\tUPLOAD_URL\r\n} from '@/api/index'\r\nimport Compressor from 'compressorjs';\r\n\r\n// 上传配置常量，\r\nconst UPLOAD_CONFIG = {\r\n\t// 不同平台的压缩质量配置\r\n\tcompressQuality: {\r\n\t\tapp: 60, // App端压缩质量(0-100)\r\n\t\th5: 0.6, // H5端压缩质量(0-1)\r\n\t\tmpWeixin: 30 // 微信小程序压缩质量(0-100)\r\n\t},\r\n\t// 提示信息配置\r\n\tmessages: {\r\n\t\tuploading: '上传中',\r\n\t\tsuccess: '上传成功',\r\n\t\tfail: '上传失败',\r\n\t\tcompressFail: '图片压缩失败',\r\n\t\tinvalidFile: '无效的文件',\r\n\t\tunsupportedPlatform: '不支持的平台'\r\n\t}\r\n};\r\n\r\n/**\r\n * 获取当前运行平台\r\n * @returns {Number} 1:App, 2:H5, 3:微信小程序, 0:未知\r\n */\r\nexport function getPlatform() {\r\n\t/*#ifdef APP-PLUS*/\r\n\treturn 1;\r\n\t/*#endif*/\r\n\r\n\t/*#ifdef H5*/\r\n\treturn 2;\r\n\t/*#endif*/\r\n\r\n\t/*#ifdef MP-WEIXIN*/\r\n\treturn 3;\r\n\t/*#endif*/\r\n\r\n\treturn 0;\r\n}\r\n\r\n/**\r\n * 图片压缩处理，适配多平台\r\n * @param {Object|String} file - 文件对象或文件路径\r\n * @returns {Promise<Object|String>} 压缩后的文件对象或路径\r\n */\r\nexport const compressPictures = async (file) => {\r\n\t// 参数校验\r\n\tif (!file) {\r\n\t\tthrow new Error(UPLOAD_CONFIG.messages.invalidFile);\r\n\t}\r\n\r\n\tconst platform = getPlatform();\r\n\tconst fileSource = file.path || file; // 统一获取文件源\r\n\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tswitch (platform) {\r\n\t\t\tcase 1: // App端\r\n\t\t\t\tuni.compressImage({\r\n\t\t\t\t\tsrc: fileSource,\r\n\t\t\t\t\tquality: UPLOAD_CONFIG.compressQuality.app,\r\n\t\t\t\t\tsuccess: (res) => resolve(res.tempFilePath),\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\tconsole.error('App图片压缩失败:', err);\r\n\t\t\t\t\t\treject(new Error(UPLOAD_CONFIG.messages.compressFail));\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 2: // H5端\r\n\t\t\t\tnew Compressor(file, {\r\n\t\t\t\t\tquality: UPLOAD_CONFIG.compressQuality.h5,\r\n\t\t\t\t\tconvertSize: false,\r\n\t\t\t\t\tsuccess: (result) => {\r\n\t\t\t\t\t\t// 转换为标准File对象\r\n\t\t\t\t\t\tconst compressedFile = new File(\r\n\t\t\t\t\t\t\t[result],\r\n\t\t\t\t\t\t\tresult.name || 'compressed-image.jpg', {\r\n\t\t\t\t\t\t\t\ttype: result.type || 'image/jpeg'\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\tresolve(compressedFile);\r\n\t\t\t\t\t},\r\n\t\t\t\t\terror: (err) => {\r\n\t\t\t\t\t\tconsole.error('H5图片压缩失败:', err);\r\n\t\t\t\t\t\treject(new Error(UPLOAD_CONFIG.messages.compressFail));\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 3: // 微信小程序端\r\n\t\t\t\tuni.compressImage({\r\n\t\t\t\t\tsrc: fileSource,\r\n\t\t\t\t\tquality: UPLOAD_CONFIG.compressQuality.mpWeixin,\r\n\t\t\t\t\tsuccess: (res) => resolve(res.tempFilePath),\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\tconsole.error('小程序图片压缩失败:', err);\r\n\t\t\t\t\t\treject(new Error(UPLOAD_CONFIG.messages.compressFail));\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\t\t\t\treject(new Error(UPLOAD_CONFIG.messages.unsupportedPlatform));\r\n\t\t}\r\n\t});\r\n};\r\n\r\n/**\r\n * 创建上传参数配置\r\n * @param {Number} platform - 平台类型\r\n * @param {String} uploadPath - 上传路径\r\n * @param {Object|String} compressedFile - 压缩后的文件\r\n * @returns {Object} 上传配置\r\n */\r\nconst createUploadOptions = (platform, uploadPath, compressedFile) => {\r\n\tconst baseOptions = {\r\n\t\turl: `${request.UPLOAD_URL}${uploadPath}`,\r\n\t\tname: 'file',\r\n\t\tformData: {\r\n\t\t\toutput: 'json2'\r\n\t\t}\r\n\t};\r\n\r\n\t// 根据平台添加不同的文件参数\r\n\tif (platform === 2) {\r\n\t\t// H5端使用file参数\r\n\t\treturn {\r\n\t\t\t...baseOptions,\r\n\t\t\tfile: compressedFile\r\n\t\t};\r\n\t} else {\r\n\t\t// App和小程序端使用filePath参数\r\n\t\treturn {\r\n\t\t\t...baseOptions,\r\n\t\t\tfilePath: compressedFile\r\n\t\t};\r\n\t}\r\n};\r\n\r\n/**\r\n * 图片上传Hook\r\n * @param {Object} opts - 上传参数\r\n * @param {String} opts.uploadPath - 上传接口路径\r\n * @param {Object|String} opts.file - 待上传的文件对象或路径\r\n * @returns {Object} 包含upload方法的对象\r\n */\r\nexport const useUpload = (opts) => {\r\n\t// 解构并校验必要参数\r\n\tconst {\r\n\t\tuploadPath,\r\n\t\tfile\r\n\t} = opts;\r\n\tif (!uploadPath || !file) {\r\n\t\tthrow new Error('缺少必要的上传参数(uploadPath或file)');\r\n\t}\r\n\r\n\t/**\r\n\t * 执行上传操作\r\n\t * @returns {Promise<Object>} 上传结果\r\n\t */\r\n\tconst upload = async () => {\r\n\t\t// 显示加载状态\r\n\t\tuni.showLoading({\r\n\t\t\ttitle: UPLOAD_CONFIG.messages.uploading,\r\n\t\t\tmask: true\r\n\t\t});\r\n\r\n\t\ttry {\r\n\t\t\tconst platform = getPlatform();\r\n\t\t\tif (platform === 0) {\r\n\t\t\t\tthrow new Error(UPLOAD_CONFIG.messages.unsupportedPlatform);\r\n\t\t\t}\r\n\r\n\t\t\t// 压缩图片\r\n\t\t\tconst compressedFile = await compressPictures(file);\r\n\r\n\t\t\t// 创建上传配置\r\n\t\t\tconst uploadOptions = createUploadOptions(platform, uploadPath, compressedFile);\r\n\r\n\t\t\t// 执行上传\r\n\t\t\treturn new Promise((resolve, reject) => {\r\n\t\t\t\tuni.uploadFile({\r\n\t\t\t\t\t...uploadOptions,\r\n\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\t// 处理返回数据，尝试解析JSON\r\n\t\t\t\t\t\tlet resultData = res.data;\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tresultData = res.data\r\n\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\tconsole.warn('上传返回数据不是JSON格式:', res.data);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: UPLOAD_CONFIG.messages.success\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tresolve(resultData);\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\tconsole.error(`平台[${platform}]上传失败:`, err);\r\n\t\t\t\t\t\treject(new Error(UPLOAD_CONFIG.messages.fail));\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} catch (error) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: error.message || UPLOAD_CONFIG.messages.fail,\r\n\t\t\t\ticon: 'error'\r\n\t\t\t});\r\n\t\t\tthrow error; // 继续抛出错误，让调用者可以捕获\r\n\t\t} finally {\r\n\t\t\t// 确保加载状态始终关闭\r\n\t\t\tuni.hideLoading();\r\n\t\t}\r\n\t};\r\n\r\n\treturn {\r\n\t\tupload\r\n\t};\r\n};"],"names":["uni","Compressor","request"],"mappings":"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"}